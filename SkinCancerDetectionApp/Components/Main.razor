@page "/"

@implements IAsyncDisposable

@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<div class="page">
    @if (_lastError is not null)
    {
        <p>Could not start video: @_lastError</p>

        if (HasReloaded == true)
        {
            <p>You may need to open the settings app to enable camera access for this app</p>
        }

        <button @onclick="Reload">Reload</button>
    }
    else
    {
        <video @ref="_videoReference" id="videoFeed">The current WebView does not support video.</video>
        <canvas class="d-none" id="currentFrame" width=@WIDTH height=@HEIGHT />
        <button class="capture-button" @onclick="CaptureFrame"></button>
    }
</div>

@code {
    private ElementReference? _videoReference;
    private string? _lastError;
    private int WIDTH = 320;
    private int HEIGHT = 240;

    [Parameter]
    [SupplyParameterFromQuery(Name = "reloaded")]
    public bool? HasReloaded { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _lastError = await JS.InvokeAsync<string?>("startCameraFeed", _videoReference);
            StateHasChanged();
        }
    }

    private void Reload()
    {
        var reloadedUri = NavigationManager.GetUriWithQueryParameter("reloaded", true);
        NavigationManager.NavigateTo(reloadedUri, true);
    }

    private async Task CaptureFrame()
    {
        await JS.InvokeVoidAsync(
            "getFrame", "videoFeed", "currentFrame", WIDTH, HEIGHT, DotNetObjectReference.Create(this));
    }

    [JSInvokable]
    public void ProcessImage(string imageString)
    {
        byte[] imageData = Convert.FromBase64String(imageString);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        await JS.InvokeVoidAsync("stopCameraFeed", _videoReference);
    }
}